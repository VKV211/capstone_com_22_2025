<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Expert Chat Panel</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary-color: #3498db;
    --primary-dark: #2980b9;
    --primary-light: #85c1e9;
    --secondary-color: #f8f9fa;
    --text-color: #2c3e50;
    --text-light: #7f8c8d;
    --border-color: #e1e8ed;
    --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    --shadow-hover: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
    color: var(--text-color);
    overflow: hidden;
  }

  /* Header Styles */
  .header {
    background: var(--primary-color);
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    box-shadow: var(--shadow);
    z-index: 100;
  }

  .header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
  }

  .header h1 i {
    margin-right: 10px;
  }

  .status {
    margin-left: auto;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    background: #2ecc71;
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* Main Container */
  .container {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* User List Styles */
  #userList {
    width: 320px;
    background: white;
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
  }

  .user-list-header {
    padding: 20px;
    background: var(--secondary-color);
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--text-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .user-count {
    background: var(--primary-color);
    color: white;
    border-radius: 20px;
    padding: 2px 10px;
    font-size: 0.8rem;
    font-weight: normal;
  }

  #users {
    flex: 1;
    overflow-y: auto;
  }

  .user-item {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    position: relative;
  }

  .user-item:hover {
    background: var(--secondary-color);
  }

  .user-item.active {
    background: rgba(52, 152, 219, 0.1);
    border-left: 4px solid var(--primary-color);
  }

  .user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: bold;
    color: white;
    font-size: 1.2rem;
    position: relative;
    overflow: hidden;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .user-status {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #2ecc71;
    border: 2px solid white;
  }

  .user-details {
    flex: 1;
    overflow: hidden;
  }

  .user-name {
    font-weight: 600;
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .user-last-message {
    font-size: 0.85rem;
    color: var(--text-light);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .user-time {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-left: 10px;
  }

  .unread-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #e74c3c;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
  }

  /* Chat Area Styles */
  #chatArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
  }

  .chat-header {
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  .chat-header-info {
    display: flex;
    align-items: center;
  }

  .chat-header-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: white;
    font-weight: bold;
  }

  .chat-header-details h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .chat-header-details p {
    margin: 0;
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .chat-actions {
    margin-left: auto;
    display: flex;
    gap: 15px;
  }

  .chat-actions button {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    font-size: 1.2rem;
    transition: color 0.3s ease;
  }

  .chat-actions button:hover {
    color: var(--primary-color);
  }

  #messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: #f8f9fa;
  }

  .date-divider {
    text-align: center;
    margin: 10px 0;
    position: relative;
  }

  .date-divider span {
    background: #f8f9fa;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.8rem;
    color: var(--text-light);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .message {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message.user {
    align-self: flex-start;
    background: white;
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
  }

  .message.expert {
    align-self: flex-end;
    background: var(--primary-color);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .message-header {
    font-size: 0.75rem;
    margin-bottom: 5px;
    opacity: 0.7;
    display: flex;
    align-items: center;
  }

  .message-content {
    line-height: 1.4;
  }

  .message-time {
    font-size: 0.7rem;
    margin-top: 5px;
    opacity: 0.7;
    text-align: right;
  }

  .message-status {
    display: inline-block;
    margin-left: 5px;
    font-size: 0.8rem;
  }

  #inputArea {
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    background: white;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .input-actions {
    display: flex;
    gap: 10px;
  }

  .input-actions button {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    font-size: 1.2rem;
    transition: color 0.3s ease;
  }

  .input-actions button:hover {
    color: var(--primary-color);
  }

  #message {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 24px;
    outline: none;
    font-size: 0.95rem;
    transition: border-color 0.3s ease;
  }

  #message:focus {
    border-color: var(--primary-color);
  }

  #sendBtn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  #sendBtn:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
  }

  #sendBtn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: scale(1);
  }

  /* Empty State */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-light);
    text-align: center;
    padding: 20px;
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: var(--primary-light);
  }

  .empty-state h3 {
    margin-bottom: 10px;
    color: var(--text-color);
  }

  /* Loading State */
  .loading {
    display: flex;
    justify-content: center;
    padding: 20px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(52, 152, 219, 0.2);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Notification Styles */
  .notification-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .notification {
    background: white;
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: var(--shadow-hover);
    display: flex;
    align-items: center;
    min-width: 300px;
    transform: translateX(400px);
    transition: transform 0.3s ease;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification i {
    font-size: 1.5rem;
    margin-right: 15px;
  }

  .notification.info i {
    color: var(--primary-color);
  }

  .notification.success i {
    color: #2ecc71;
  }

  .notification.error i {
    color: #e74c3c;
  }

  .notification-content {
    flex: 1;
  }

  .notification-title {
    font-weight: 600;
    margin-bottom: 5px;
  }

  .notification-message {
    font-size: 0.9rem;
    color: var(--text-light);
  }

  .notification-close {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    font-size: 1rem;
    margin-left: 10px;
  }

  /* Typing Indicator */
  .typing-indicator {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background: white;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    width: fit-content;
    margin-bottom: 10px;
  }

  .typing-indicator span {
    height: 8px;
    width: 8px;
    background: var(--text-light);
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: typing 1.4s infinite;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 60%, 100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-10px);
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    #userList {
      width: 100%;
      position: absolute;
      left: -100%;
      z-index: 50;
      transition: left 0.3s ease;
    }

    #userList.show {
      left: 0;
    }

    .mobile-toggle {
      display: block;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 60;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
  }

  @media (min-width: 769px) {
    .mobile-toggle {
      display: none;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h1><i class="fas fa-comments"></i> Expert Chat Panel</h1>
  <div class="status">
    <div class="status-dot"></div>
    <span>Online</span>
  </div>
</div>

<div class="container">
  <button class="mobile-toggle" id="mobileToggle">
    <i class="fas fa-bars"></i>
  </button>
  
  <div id="userList">
    <div class="user-list-header">
      <span>Conversations</span>
      <span class="user-count" id="userCount">0</span>
    </div>
    <div id="users">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <div id="chatArea">
    <div class="chat-header" id="chatHeader" style="display: none;">
      <div class="chat-header-info">
        <div class="chat-header-avatar" id="chatHeaderAvatar">?</div>
        <div class="chat-header-details">
          <h3 id="chatHeaderName">Select a conversation</h3>
          <p id="chatHeaderStatus">Active now</p>
        </div>
      </div>
      <div class="chat-actions">
        <button title="Search"><i class="fas fa-search"></i></button>
        <button title="More options"><i class="fas fa-ellipsis-v"></i></button>
      </div>
    </div>
    
    <div id="messages">
      <div class="empty-state">
        <i class="fas fa-comments"></i>
        <h3>Welcome to Expert Chat</h3>
        <p>Select a conversation from the list to start messaging</p>
      </div>
    </div>
    
    <div id="inputArea">
      <div class="input-actions">
        <button title="Attach file"><i class="fas fa-paperclip"></i></button>
      </div>
      <input id="message" placeholder="Type a message..." disabled />
      <button id="sendBtn" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<div class="notification-container" id="notificationContainer"></div>

<script>
// Configuration
const SUPABASE_URL = "https://mrjsyohjxglscrfgmnvb.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yanN5b2hqeGdsc2NyZmdtbnZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTcxMTYsImV4cCI6MjA3NDM3MzExNn0.LmjYpHoTWI1DbaFAdTsxR1syeSFLaXpxd_oqgN-lofI";
const EXPERT_ID = "2b700556-7992-4001-9f00-3d5aaa84cd8f";

// Initialize Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// DOM Elements
const usersDiv = document.getElementById("users");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const mobileToggle = document.getElementById("mobileToggle");
const notificationContainer = document.getElementById("notificationContainer");
const chatHeader = document.getElementById("chatHeader");
const chatHeaderName = document.getElementById("chatHeaderName");
const chatHeaderAvatar = document.getElementById("chatHeaderAvatar");
const userCount = document.getElementById("userCount");

// State
let selectedUser = null;
let usersMap = {}; // user_id => { name, lastMessage, lastMessageTime, unreadCount }
let realtimeSubscription = null;
let typingTimeout = null;
let isTyping = false;

// Utility Functions
function showNotification(title, message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  const icon = type === 'success' ? 'check-circle' : 
               type === 'error' ? 'exclamation-circle' : 
               'info-circle';
  
  notification.innerHTML = `
    <i class="fas fa-${icon}"></i>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close"><i class="fas fa-times"></i></button>
  `;
  
  notificationContainer.appendChild(notification);
  
  // Trigger animation
  setTimeout(() => notification.classList.add('show'), 10);
  
  // Auto remove after 5 seconds
  const timeout = setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  }, 5000);
  
  // Manual close
  notification.querySelector('.notification-close').addEventListener('click', () => {
    clearTimeout(timeout);
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  });
}

function formatTime(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  
  if (diffMins < 1) return 'now';
  if (diffMins < 60) return `${diffMins}m`;
  
  const diffHours = Math.floor(diffMins / 60);
  if (diffHours < 24) return `${diffHours}h`;
  
  return date.toLocaleDateString();
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  if (date >= today) return 'Today';
  if (date >= yesterday) return 'Yesterday';
  
  return date.toLocaleDateString();
}

function getInitials(name) {
  if (!name) return '?';
  return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

// Mobile Menu Toggle
mobileToggle.addEventListener('click', () => {
  document.getElementById('userList').classList.toggle('show');
});

// Load all users who have sent messages to the expert
async function loadUsers() {
  try {
    console.log('Loading users...');
    
    // First, get all unique user IDs from chats
    const { data: chats, error: chatsError } = await supabase
      .from("chats")
      .select("sender_id, receiver_id, message, created_at");

    if (chatsError) {
      console.error('Error fetching chats:', chatsError);
      throw chatsError;
    }

    console.log('Chats loaded:', chats.length);

    const userIds = new Set();
    const lastMessages = {};

    chats.forEach(chat => {
      // Determine the other user in the conversation
      const otherUserId = chat.sender_id === EXPERT_ID ? chat.receiver_id : chat.sender_id;
      
      // Skip if this is the expert
      if (otherUserId === EXPERT_ID) return;
      
      userIds.add(otherUserId);
      
      // Track the last message for each user
      if (!lastMessages[otherUserId] || new Date(chat.created_at) > new Date(lastMessages[otherUserId].created_at)) {
        lastMessages[otherUserId] = {
          message: chat.message,
          created_at: chat.created_at,
          isFromExpert: chat.sender_id === EXPERT_ID
        };
      }
    });

    console.log('Unique user IDs:', Array.from(userIds));

    if (userIds.size === 0) {
      usersDiv.innerHTML = '<div class="empty-state"><p>No conversations found</p></div>';
      userCount.textContent = '0';
      return;
    }

    // Fetch profiles for all users
    const { data: profiles, error: profilesError } = await supabase
      .from("profiles")
      .select("id, name")
      .in("id", Array.from(userIds));

    if (profilesError) {
      console.error('Error fetching profiles:', profilesError);
      throw profilesError;
    }

    console.log('Profiles loaded:', profiles.length);

    // Create a map of user IDs to profiles
    const profilesMap = {};
    profiles.forEach(profile => {
      profilesMap[profile.id] = profile;
    });

    // Update usersMap with profile info and last message
    usersMap = {};
    Array.from(userIds).forEach(userId => {
      const profile = profilesMap[userId];
      usersMap[userId] = {
        name: profile ? profile.name : `User ${userId.substring(0, 8)}`,
        ...lastMessages[userId],
        unreadCount: 0
      };
    });

    console.log('Users map created:', usersMap);

    // Update user count
    userCount.textContent = userIds.size;

    // Render users
    renderUsers();
    
    // Show notification
    showNotification('Success', `Loaded ${userIds.size} conversations`, 'success');
  } catch (error) {
    console.error('Error in loadUsers:', error);
    showNotification('Error', 'Failed to load conversations', 'error');
    usersDiv.innerHTML = '<div class="empty-state"><p>Error loading conversations</p></div>';
  }
}

function renderUsers() {
  usersDiv.innerHTML = "";
  
  // Sort users by last message time (most recent first)
  const sortedUserIds = Object.keys(usersMap).sort((a, b) => {
    const timeA = new Date(usersMap[a].created_at || 0);
    const timeB = new Date(usersMap[b].created_at || 0);
    return timeB - timeA;
  });

  sortedUserIds.forEach(userId => {
    const userInfo = usersMap[userId];
    const userDiv = document.createElement("div");
    userDiv.className = "user-item";
    if (selectedUser === userId) userDiv.classList.add("active");
    
    const initials = getInitials(userInfo.name);
    const lastMessagePreview = userInfo.message ? 
      (userInfo.isFromExpert ? `You: ${userInfo.message}` : userInfo.message) : 
      "No messages";
    
    userDiv.innerHTML = `
      <div class="user-avatar">${initials}</div>
      <div class="user-details">
        <div class="user-name">${userInfo.name}</div>
        <div class="user-last-message">${lastMessagePreview}</div>
      </div>
      <div class="user-time">${userInfo.created_at ? formatTime(userInfo.created_at) : ''}</div>
      ${userInfo.unreadCount > 0 ? `<div class="unread-badge">${userInfo.unreadCount}</div>` : ''}
    `;
    
    userDiv.onclick = () => selectUser(userId, userDiv);
    usersDiv.appendChild(userDiv);
  });
}

// Select a user and load their messages
function selectUser(userId, element) {
  selectedUser = userId;
  
  // Update active state
  document.querySelectorAll(".user-item").forEach(el => el.classList.remove("active"));
  element.classList.add("active");
  
  // Reset unread count
  usersMap[userId].unreadCount = 0;
  renderUsers();
  
  // Update chat header
  const userInfo = usersMap[userId];
  chatHeaderName.textContent = userInfo.name;
  chatHeaderAvatar.textContent = getInitials(userInfo.name);
  chatHeader.style.display = 'flex';
  
  // Enable input
  messageInput.disabled = false;
  sendBtn.disabled = false;
  
  // Close mobile menu if open
  document.getElementById('userList').classList.remove('show');
  
  // Load messages
  loadMessages();
}

// Load messages for the selected user
async function loadMessages() {
  if (!selectedUser) return;

  try {
    messagesDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    // Fixed query syntax - using proper Supabase filter syntax
    const { data, error } = await supabase
      .from("chats")
      .select("*")
      .or(`and(sender_id.eq.${EXPERT_ID},receiver_id.eq.${selectedUser}),and(sender_id.eq.${selectedUser},receiver_id.eq.${EXPERT_ID})`)
      .order("created_at", { ascending: true });

    if (error) {
      console.error('Error loading messages:', error);
      throw error;
    }

    messagesDiv.innerHTML = "";
    
    if (data.length === 0) {
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comment-dots"></i>
          <h3>No messages yet</h3>
          <p>Start a conversation with ${usersMap[selectedUser]?.name || 'this user'}</p>
        </div>
      `;
      return;
    }

    // Track date changes for dividers
    let lastDate = null;
    
    // Display messages
    data.forEach(msg => {
      // Add date divider if needed
      const messageDate = new Date(msg.created_at).toDateString();
      if (messageDate !== lastDate) {
        lastDate = messageDate;
        const dateDiv = document.createElement("div");
        dateDiv.className = "date-divider";
        dateDiv.innerHTML = `<span>${formatDate(msg.created_at)}</span>`;
        messagesDiv.appendChild(dateDiv);
      }
      
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${msg.sender_id === EXPERT_ID ? "expert" : "user"}`;
      
      const senderName = msg.sender_id === EXPERT_ID ? 
        "You" : 
        (usersMap[msg.sender_id]?.name || `User ${msg.sender_id.substring(0, 8)}`);
      
      messageDiv.innerHTML = `
        <div class="message-header">${senderName}</div>
        <div class="message-content">${msg.message}</div>
        <div class="message-time">${formatTime(msg.created_at)}${msg.sender_id === EXPERT_ID ? '<span class="message-status"><i class="fas fa-check"></i></span>' : ''}</div>
      `;
      
      messagesDiv.appendChild(messageDiv);
    });

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch (error) {
    console.error('Error in loadMessages:', error);
    showNotification('Error', 'Failed to load messages', 'error');
    messagesDiv.innerHTML = '<div class="empty-state"><p>Error loading messages</p></div>';
  }
}

// Send a message
async function sendMessage() {
  const messageText = messageInput.value.trim();
  if (!selectedUser || !messageText) return;

  try {
    sendBtn.disabled = true;
    
    const { error } = await supabase.from("chats").insert({
      sender_id: EXPERT_ID,
      receiver_id: selectedUser,
      message: messageText,
    });

    if (error) {
      console.error('Error sending message:', error);
      throw error;
    }
    
    messageInput.value = "";
    
    // Update last message for this user
    usersMap[selectedUser] = {
      ...usersMap[selectedUser],
      message: messageText,
      created_at: new Date().toISOString(),
      isFromExpert: true
    };
    
    // Re-render users list
    renderUsers();
    
    // Show notification
    showNotification('Message Sent', `Your message to ${usersMap[selectedUser].name} was sent`, 'success');
  } catch (error) {
    console.error('Error in sendMessage:', error);
    showNotification('Error', 'Failed to send message', 'error');
  } finally {
    sendBtn.disabled = false;
    messageInput.focus();
  }
}

// Handle typing indicator
function handleTyping() {
  if (!isTyping) {
    isTyping = true;
    // In a real app, you would emit a typing event to the server
  }
  
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    isTyping = false;
    // In a real app, you would emit a stop typing event to the server
  }, 1000);
}

// Set up real-time subscription
function setupRealtimeSubscription() {
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }
  
  realtimeSubscription = supabase
    .channel('chats')
    .on('postgres_changes', 
      { 
        event: '*', 
        schema: 'public', 
        table: 'chats',
        filter: `or=(sender_id.eq.${EXPERT_ID},receiver_id.eq.${EXPERT_ID})`
      }, 
      (payload) => {
        console.log('Realtime update:', payload);
        
        const newMessage = payload.new;
        const otherUserId = newMessage.sender_id === EXPERT_ID ? 
          newMessage.receiver_id : newMessage.sender_id;
        
        // If this is a new user, reload the users list
        if (!usersMap[otherUserId]) {
          loadUsers();
        } else {
          // Update the last message for this user
          usersMap[otherUserId] = {
            ...usersMap[otherUserId],
            message: newMessage.message,
            created_at: newMessage.created_at,
            isFromExpert: newMessage.sender_id === EXPERT_ID
          };
          
          // If this is a message from another user and not the currently selected user, increment unread count
          if (newMessage.sender_id !== EXPERT_ID && selectedUser !== otherUserId) {
            usersMap[otherUserId].unreadCount = (usersMap[otherUserId].unreadCount || 0) + 1;
            
            // Show notification for new message
            showNotification(
              'New Message', 
              `${usersMap[otherUserId].name}: ${newMessage.message}`,
              'info'
            );
          }
          
          // Re-render users list
          renderUsers();
          
          // If this is the currently selected user, reload messages
          if (selectedUser === otherUserId) {
            loadMessages();
          }
        }
      }
    )
    .subscribe((status) => {
      console.log('Realtime subscription status:', status);
    });
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

messageInput.addEventListener('input', handleTyping);

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadUsers();
  setupRealtimeSubscription();
});

// Cleanup
window.addEventListener('beforeunload', () => {
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }
});
</script>

</body>
</html>